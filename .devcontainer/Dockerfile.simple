FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

# Basic setup
RUN apt-get update && \
    apt-get install -y \
    curl \
    git \
    python3 \
    python3-pip \
    nodejs \
    npm \
    sudo \
    fuse \
    file \
    && npm install -g @anthropic-ai/claude-code \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install latest Neovim with correct filename
RUN mkdir -p /opt && \
    echo "Downloading Neovim..." && \
    curl -fsSL --retry 3 https://github.com/neovim/neovim/releases/latest/download/nvim-linux-x86_64.tar.gz -o /tmp/nvim-linux-x86_64.tar.gz && \
    echo "Verifying download..." && \
    file /tmp/nvim-linux-x86_64.tar.gz && \
    echo "Extracting Neovim..." && \
    tar -C /opt -xzf /tmp/nvim-linux-x86_64.tar.gz && \
    echo "Setting up Neovim..." && \
    chmod +x /opt/nvim-linux-x86_64/bin/nvim && \
    ln -sf /opt/nvim-linux-x86_64/bin/nvim /usr/local/bin/nvim && \
    rm /tmp/nvim-linux-x86_64.tar.gz && \
    echo "Testing Neovim installation..." && \
    nvim --version

# Create non-root user
RUN useradd -m -s /bin/bash vscode && \
    echo "vscode ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

USER vscode
WORKDIR /home/vscode

# Install lazy.nvim
RUN git clone --filter=blob:none https://github.com/folke/lazy.nvim.git --branch=stable \
    ~/.local/share/nvim/lazy

CMD ["/bin/bash"]